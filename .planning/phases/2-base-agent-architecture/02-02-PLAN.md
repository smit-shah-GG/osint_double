---
phase: 02-base-agent-architecture
plan: 02
type: execute
---

<objective>
Implement message bus, agent registry, and communication schemas.

Purpose: Create the broadcasting and discovery infrastructure for agent swarm communication.
Output: Working aiopubsub message bus, agent registry with discovery, Pydantic message schemas.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/2-base-agent-architecture/2-RESEARCH.md
@.planning/phases/2-base-agent-architecture/2-CONTEXT.md
@.planning/phases/2-base-agent-architecture/02-01-SUMMARY.md
@osint_system/agents/base_agent.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement aiopubsub message bus</name>
  <files>osint_system/agents/communication/bus.py</files>
  <action>Create MessageBus class using aiopubsub Hub. Implement singleton pattern for shared bus instance. Add methods for publishing messages (broadcast_capability, request_service, send_response). Add subscription management (subscribe_to_pattern, unsubscribe). Use key patterns like "discovery.*", "agent.{name}.*", "broadcast.*" as shown in RESEARCH.md. Include async context manager for clean shutdown.</action>
  <verify>python -c "from osint_system.agents.communication.bus import MessageBus; bus = MessageBus(); print('Bus initialized')"</verify>
  <done>MessageBus singleton works, can publish/subscribe, no import errors</done>
</task>

<task type="auto">
  <name>Task 2: Build agent registry for discovery</name>
  <files>osint_system/agents/registry.py</files>
  <action>Create AgentRegistry class for agent discovery and tracking. Store agent metadata: id, name, capabilities list, status (active/inactive), last_seen timestamp. Implement register_agent(), unregister_agent(), find_agents_by_capability(), get_active_agents(). Use asyncio locks for thread-safe updates. Subscribe to "discovery.announce" messages to auto-register broadcasting agents. Include periodic heartbeat checking.</action>
  <verify>python -c "from osint_system.agents.registry import AgentRegistry; registry = AgentRegistry(); print('Registry ready')"</verify>
  <done>Registry tracks agents, capability search works, thread-safe operations</done>
</task>

<task type="auto">
  <name>Task 3: Create Pydantic message schemas</name>
  <files>osint_system/agents/communication/messages.py</files>
  <action>Define Pydantic models for agent communication. Create BaseMessage with id, timestamp, from_agent, to_agent fields. Create CapabilityAnnouncement(capabilities: list[str], agent_name: str). Create ServiceRequest(capability_needed: str, payload: dict). Create ServiceResponse(success: bool, result: Any, error: Optional[str]). Add message type discriminator field. Use pydantic.Field for validation rules.</action>
  <verify>python -c "from osint_system.agents.communication.messages import CapabilityAnnouncement, ServiceRequest; print('Schemas valid')"</verify>
  <done>All message schemas defined, validation works, serialization to/from JSON works</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Message bus can publish and subscribe
- [ ] Agent registry tracks and queries agents
- [ ] Pydantic schemas validate correctly
- [ ] No circular imports between modules
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Thread-safe operations confirmed
- Message patterns follow conventions
</success_criteria>

<output>
After completion, create `.planning/phases/2-base-agent-architecture/02-02-SUMMARY.md`:

# Phase 2 Plan 2: Message Bus & Registry Summary

**[One-liner about what was accomplished]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `file.py` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 02-03-PLAN.md
</output>
---
phase: 03-planning-orchestration
plan: 03
type: execute
---

<objective>
Implement supervisor-worker coordination patterns with iterative refinement and hierarchical delegation capabilities.

Purpose: Enable the planning agent to iteratively refine investigations based on discoveries and create sub-coordinators for complex objectives.
Output: Complete planning and orchestration system with refinement loops, hierarchical coordination, and conflict tracking.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/3-planning-orchestration/03-RESEARCH.md
@.planning/phases/3-planning-orchestration/03-CONTEXT.md
@.planning/phases/3-planning-orchestration/03-01-SUMMARY.md
@.planning/phases/3-planning-orchestration/03-02-SUMMARY.md
@osint_system/agents/planning_agent.py
@osint_system/orchestration/task_queue.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement iterative refinement loop</name>
  <files>osint_system/orchestration/refinement/iterative.py, osint_system/agents/planning_agent.py</files>
  <action>
    Create RefinementEngine class with iterative refinement capabilities. Implement refine_approach method that analyzes findings, generates follow-up questions, and creates targeted subtasks for deeper investigation.

    Add reflection mechanism: reflect_on_findings method that critiques current findings, identifies gaps, and suggests new exploration angles. Include MAX_ITERATIONS=7 limit to prevent infinite loops.

    Update PlanningOrchestrator's refine_approach node to use RefinementEngine. Track refinement history in state for transparency. Store reasoning for each refinement decision.

    Implement should_continue_refinement logic checking: iteration count, signal strength changes, coverage improvements, novelty of findings.
  </action>
  <verify>python -c "from osint_system.orchestration.refinement.iterative import RefinementEngine; e = RefinementEngine(); print('RefinementEngine created')"</verify>
  <done>Iterative refinement with reflection, follow-up generation, and loop prevention</done>
</task>

<task type="auto">
  <name>Task 2: Create hierarchical sub-coordinator support</name>
  <files>osint_system/orchestration/refinement/hierarchical.py</files>
  <action>
    Implement SubCoordinator class that can manage a subset of agents for specific source types. Create SubCoordinatorFactory with create_by_source_type method that groups agents by capability (news, social, document).

    Add delegation logic: when objective has multiple distinct aspects, create sub-coordinators for parallel exploration. Each sub-coordinator gets its own StateGraph but reports back to main orchestrator.

    Implement aggregation: combine_sub_coordinator_results method that merges findings while preserving source attribution. Track which sub-coordinator discovered what for transparency.

    Use langgraph's subgraph pattern for clean hierarchical structure. Limit hierarchy to 2 levels to avoid complexity explosion.
  </action>
  <verify>python -c "from osint_system.orchestration.refinement.hierarchical import SubCoordinator, SubCoordinatorFactory; print('Hierarchical support loaded')"</verify>
  <done>Sub-coordinator creation, delegation logic, and result aggregation implemented</done>
</task>

<task type="auto">
  <name>Task 3: Add conflict tracking and integration tests</name>
  <files>osint_system/agents/planning_agent.py, tests/integration/test_planning_orchestration.py</files>
  <action>
    Add conflict tracking to PlanningOrchestrator: track_conflict method that stores contradictory information without resolution. Structure: {topic, version_a, source_a, version_b, source_b, timestamp}.

    Enhance transparency: add get_reasoning_trace method showing complete decision history, add get_conflict_report listing all unresolved contradictions.

    Create comprehensive integration tests: test full refinement loop with mocked agents, test hierarchical delegation with sub-coordinators, test conflict detection and tracking, test stopping conditions (max iterations, diminishing returns).

    Add checkpoint:human-verify task to verify the orchestration system works correctly with a simple objective.
  </action>
  <verify>uv run python -m pytest tests/integration/test_planning_orchestration.py -v</verify>
  <done>Conflict tracking added, transparency enhanced, integration tests pass</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Planning & Orchestration Agent with adaptive routing, task prioritization, and refinement capabilities</what-built>
  <how-to-verify>
    1. Run: uv run python -c "from osint_system.agents.planning_agent import PlanningOrchestrator; p = PlanningOrchestrator(); print(p.describe())"
    2. Verify orchestrator description shows: StateGraph structure, refinement capabilities, sub-coordinator support
    3. Run: uv run python -m pytest tests/ -k planning -v
    4. Confirm all planning-related tests pass
    5. Check that planning agent can: decompose objectives, track refinements, handle conflicts
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] All unit tests pass for planning components
- [ ] Integration tests demonstrate full orchestration flow
- [ ] Refinement loop stops appropriately
- [ ] Sub-coordinators can be created and managed
- [ ] Conflicts are tracked without premature resolution
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Human verification confirms orchestration works
- Iterative refinement demonstrates adaptive behavior
- Hierarchical coordination enables parallel exploration
- Phase 3 complete: Planning & Orchestration Agent fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/3-planning-orchestration/03-03-SUMMARY.md`:

# Phase 3 Plan 3: Supervisor-Worker Coordination Summary

**Complete planning and orchestration system with refinement loops and hierarchical delegation**

## Accomplishments

- Iterative refinement with reflection
- Hierarchical sub-coordinator support
- Conflict tracking without resolution
- Full transparency and reasoning traces

## Files Created/Modified

- `osint_system/orchestration/refinement/iterative.py` - Refinement engine
- `osint_system/orchestration/refinement/hierarchical.py` - Sub-coordinator support
- `osint_system/agents/planning_agent.py` - Complete orchestrator
- `tests/integration/test_planning_orchestration.py` - Integration tests

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions]

## Next Step

Phase 3 complete. Ready for Phase 4: News Crawler Implementation
</output>
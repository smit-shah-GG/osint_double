---
phase: 08-verification-loop
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - osint_system/agents/sifters/verification/evidence_aggregator.py
  - osint_system/agents/sifters/verification/reclassifier.py
  - osint_system/agents/sifters/verification/__init__.py
  - tests/agents/sifters/verification/test_evidence_aggregator.py
  - tests/agents/sifters/verification/test_reclassifier.py
autonomous: true

must_haves:
  truths:
    - "High-authority source (>=0.85) can single-handedly confirm a claim"
    - "2+ independent lower-authority sources required for confirmation without high-authority"
    - "Confidence boost is graduated: +0.3 wire, +0.2 news, +0.1 social"
    - "Refutation requires evidence, not just absence of confirmation"
    - "Origin dubious flags preserved as metadata after confirmation"
    - "Temporal contradictions mark loser as SUPERSEDED, factual as REFUTED"
  artifacts:
    - path: "osint_system/agents/sifters/verification/evidence_aggregator.py"
      provides: "Authority-weighted evidence aggregation"
      exports: ["EvidenceAggregator"]
      min_lines: 180
    - path: "osint_system/agents/sifters/verification/reclassifier.py"
      provides: "Status transition and re-classification logic"
      exports: ["Reclassifier"]
      min_lines: 200
    - path: "tests/agents/sifters/verification/test_evidence_aggregator.py"
      provides: "Evidence aggregation tests"
      min_lines: 120
    - path: "tests/agents/sifters/verification/test_reclassifier.py"
      provides: "Re-classification tests"
      min_lines: 120
  key_links:
    - from: "osint_system/agents/sifters/verification/evidence_aggregator.py"
      to: "osint_system/agents/sifters/credibility/source_scorer.py"
      via: "SourceCredibilityScorer for authority scoring"
      pattern: "from osint_system\\.agents\\.sifters\\.credibility.*import.*SourceCredibilityScorer"
    - from: "osint_system/agents/sifters/verification/evidence_aggregator.py"
      to: "osint_system/config/source_credibility.py"
      via: "authority scoring constants"
      pattern: "DOMAIN_PATTERN_DEFAULTS|SOURCE_BASELINES"
    - from: "osint_system/agents/sifters/verification/reclassifier.py"
      to: "osint_system/data_management/classification_store.py"
      via: "classification updates"
      pattern: "ClassificationStore"
    - from: "osint_system/agents/sifters/verification/reclassifier.py"
      to: "osint_system/agents/sifters/classification/impact_assessor.py"
      via: "impact tier re-assessment"
      pattern: "from osint_system\\.agents\\.sifters\\.classification.*import.*ImpactAssessor"
---

<objective>
Build evidence aggregation and re-classification systems for verification loop.

Purpose: Evaluate collected evidence to determine if facts are confirmed/refuted/unverifiable, and update classifications with proper status transitions. Per CONTEXT.md: authority-weighted corroboration, graduated confidence, and context-dependent ANOMALY resolution.

Output: EvidenceAggregator with authority-weighted thresholds, Reclassifier with status transitions preserving origin flags, and comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-verification-loop/08-CONTEXT.md
@.planning/phases/08-verification-loop/08-RESEARCH.md
@.planning/phases/08-verification-loop/08-01-SUMMARY.md
@osint_system/data_management/classification_store.py
@osint_system/config/source_credibility.py
@osint_system/agents/sifters/classification/impact_assessor.py
@osint_system/agents/sifters/credibility/source_scorer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement EvidenceAggregator with authority-weighted thresholds</name>
  <files>
    osint_system/agents/sifters/verification/evidence_aggregator.py
  </files>
  <action>
Create EvidenceAggregator class implementing CONTEXT.md evidence sufficiency rules.

**CRITICAL: Use Phase 7 SourceCredibilityScorer for authority scoring.**

Import and use the existing scorer:
```python
from osint_system.agents.sifters.credibility import SourceCredibilityScorer
from osint_system.config.source_credibility import (
    SOURCE_BASELINES,
    DOMAIN_PATTERN_DEFAULTS,
    SOURCE_TYPE_DEFAULTS,
)
```

**EvidenceAggregator class:**

```python
class EvidenceAggregator:
    """Authority-weighted evidence aggregation per CONTEXT.md.

    Confirmation thresholds:
    - 1 high-authority source (>=0.85) OR
    - 2+ independent lower-authority sources

    Graduated confidence boosts:
    - Wire service: +0.3
    - News outlet: +0.2
    - Social media: +0.1
    - Cumulative, capped at 1.0
    """
```

**Class constants (from CONTEXT.md):**
```python
CONFIDENCE_BOOSTS = {
    "wire_service": 0.3,
    "official_statement": 0.25,  # .gov domains
    "news_outlet": 0.2,
    "social_media": 0.1,
}
HIGH_AUTHORITY_THRESHOLD = 0.85  # wire_service or .gov/.edu
REFUTATION_AUTHORITY_THRESHOLD = 0.7  # Minimum for refuting evidence
```

**Constructor:**
- `high_authority_threshold: float = 0.85`
- `refutation_threshold: float = 0.7`
- `source_scorer: Optional[SourceCredibilityScorer] = None` - Use Phase 7 scorer, lazy-init if not provided
- `logger` - structlog bound to "EvidenceAggregator"

**Core method:**
```python
async def evaluate_evidence(
    self,
    fact: Dict[str, Any],
    evidence_items: List[EvidenceItem],
) -> EvidenceEvaluation:
    """Evaluate if evidence is sufficient for confirmation/refutation.

    Per CONTEXT.md:
    1. Check for high-authority single-source confirmation
    2. Check for 2+ independent lower-authority confirmation
    3. Check for refutation (requires authority >= 0.7)
    4. Otherwise, PENDING (insufficient evidence)
    """
```

**Helper methods:**

1. `_get_authority_score(self, source_url: str) -> float`:
   - **Use SourceCredibilityScorer from Phase 7** for consistent authority scoring
   - Lazy-init scorer if not provided: `self._source_scorer = self._source_scorer or SourceCredibilityScorer()`
   - Extract domain from URL
   - Call `self._source_scorer.get_source_credibility(domain)` or use the baselines directly:
     - Check SOURCE_BASELINES first (e.g., reuters.com: 0.9)
     - Then DOMAIN_PATTERN_DEFAULTS for TLDs (.gov: 0.85, .edu: 0.85)
     - Then SOURCE_TYPE_DEFAULTS for unknown sources
   - Fallback to 0.4 for unknown domains

2. `_get_source_type(self, source_url: str) -> str`:
   - Returns: "wire_service", "official_statement", "news_outlet", "social_media"
   - Based on domain patterns from SOURCE_BASELINES

3. `_filter_independent_sources(self, evidence_with_scores: List[Tuple[EvidenceItem, float]]) -> List[Tuple[EvidenceItem, float]]`:
   - Per CONTEXT.md: "Different domains AND different parent companies"
   - For MVP: different domains is sufficient (parent company tracking is Phase 10 enhancement)
   - Also exclude if sources cite the same original (URL dedup)

4. `_supports_claim(self, evidence: EvidenceItem, fact: Dict) -> bool`:
   - Returns evidence.supports_claim (set by search executor)

5. `_refutes_claim(self, evidence: EvidenceItem, fact: Dict) -> bool`:
   - Returns not evidence.supports_claim AND evidence.relevance_score >= 0.7

**Evaluation logic:**
1. Score each evidence item with _get_authority_score
2. Filter to supporting vs refuting evidence
3. Check high-authority confirmation (any authority >= 0.85 AND supports_claim)
4. If no high-authority, check 2+ independent lower-authority supporters
5. If neither, check for refutation (authority >= 0.7 AND refutes)
6. Otherwise, return PENDING

**Confidence calculation:**
- Sum confidence boosts from all supporting evidence
- Cap at 1.0
- Log breakdown for debugging
  </action>
  <verify>
`uv run python -c "
from osint_system.agents.sifters.verification.evidence_aggregator import EvidenceAggregator
from osint_system.agents.sifters.verification.schemas import EvidenceItem, VerificationStatus
import asyncio

agg = EvidenceAggregator()
# Test with high-authority evidence
wire_evidence = EvidenceItem(
    source_url='https://www.reuters.com/article',
    source_domain='reuters.com',
    source_type='wire_service',
    authority_score=0.9,
    snippet='Confirmed report',
    supports_claim=True,
    relevance_score=0.95
)
fact = {'fact_id': 'test', 'claim': {'text': 'Test claim'}}
result = asyncio.run(agg.evaluate_evidence(fact, [wire_evidence]))
print(f'Status: {result.status}')
assert result.status == VerificationStatus.CONFIRMED
"` succeeds
  </verify>
  <done>
EvidenceAggregator confirms with 1 high-authority source OR 2+ independent lower-authority, refutes with authority >= 0.7, returns PENDING otherwise. Uses Phase 7 SourceCredibilityScorer for consistent authority scoring.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Reclassifier with status transitions</name>
  <files>
    osint_system/agents/sifters/verification/reclassifier.py
  </files>
  <action>
Create Reclassifier class implementing CONTEXT.md re-classification rules.

**CRITICAL: ImpactAssessor initialization strategy**

Import ImpactAssessor from Phase 7:
```python
from osint_system.agents.sifters.classification import ImpactAssessor
```

**Reclassifier class:**

```python
class Reclassifier:
    """Re-classification logic per CONTEXT.md decisions.

    Key behaviors:
    - Preserve origin_dubious_flags before clearing (audit trail)
    - Re-assess impact tier with new evidence
    - Context-dependent ANOMALY resolution (temporal->SUPERSEDED, factual->REFUTED)
    - Update ClassificationStore with new status
    """
```

**Constructor:**
- `impact_assessor: Optional[ImpactAssessor] = None` - **Lazy-initialized on first use in reclassify_fact**
- `logger` - structlog bound to "Reclassifier"

**ImpactAssessor initialization strategy:**
The ImpactAssessor is lazy-initialized because:
1. It has no required dependencies (can be constructed with defaults)
2. Not all reclassification calls need impact re-assessment (only CONFIRMED facts)
3. Allows injection for testing while providing sensible default

```python
def _get_impact_assessor(self) -> ImpactAssessor:
    """Lazy-init ImpactAssessor on first use."""
    if self._impact_assessor is None:
        self._impact_assessor = ImpactAssessor()  # Uses defaults from Phase 7
    return self._impact_assessor
```

**Core method:**
```python
async def reclassify_fact(
    self,
    fact_id: str,
    investigation_id: str,
    verification_result: VerificationResult,
    classification_store: ClassificationStore,
    fact_store: FactStore,
) -> FactClassification:
    """Apply verification result to update classification.

    Per CONTEXT.md:
    1. Preserve origin_dubious_flags before clearing
    2. Add history entry with verification trigger
    3. Clear current dubious_flags (resolved)
    4. Apply confidence boost (capped at 1.0)
    5. Re-assess impact tier with new evidence (for CONFIRMED)
    6. Save updated classification
    """
```

**ANOMALY resolution method:**
```python
async def resolve_anomaly(
    self,
    winner_id: str,
    loser_id: str,
    contradiction_type: str,  # negation, numeric, temporal, attribution
    investigation_id: str,
    classification_store: ClassificationStore,
) -> Tuple[FactClassification, FactClassification]:
    """Resolve ANOMALY contradiction per CONTEXT.md context-dependent rules.

    Per CONTEXT.md:
    - Temporal contradictions -> loser marked SUPERSEDED
    - Factual contradictions (negation, numeric, attribution) -> loser marked REFUTED

    Returns: (winner_classification, loser_classification)
    """
```

**Implementation details:**

1. **Preserving origin flags:**
   ```python
   origin_flags = list(current_classification.dubious_flags)
   # Clear current flags (they're resolved)
   classification.dubious_flags = []
   # Store origin in verification result (already has origin_dubious_flags field)
   ```

2. **History entry:**
   ```python
   classification.add_history_entry(f"verification_{verification_result.status.value}")
   ```

3. **Confidence update:**
   ```python
   new_confidence = min(1.0, current_confidence + verification_result.confidence_boost)
   classification.credibility_score = new_confidence
   ```

4. **Impact re-assessment (CONFIRMED only):**
   Per CONTEXT.md: "Re-assess impact tier with new evidence, not simply inherited"
   ```python
   if verification_result.status == VerificationStatus.CONFIRMED:
       # Get fact from fact_store
       fact = await fact_store.get_fact(investigation_id, fact_id)
       # Enrich fact context with verification evidence
       enriched_context = {
           "objective_keywords": [],  # From investigation if available
           "verification_evidence": verification_result.supporting_evidence,
       }
       # Re-assess impact using lazy-initialized ImpactAssessor
       impact_result = self._get_impact_assessor().assess(fact, enriched_context)
       # Update impact_tier if changed
       if impact_result.tier != classification.impact_tier:
           self._logger.info(
               "impact_tier_changed",
               fact_id=fact_id,
               old_tier=classification.impact_tier.value,
               new_tier=impact_result.tier.value,
               reasoning=impact_result.reasoning,
           )
           classification.impact_tier = impact_result.tier
           classification.impact_reasoning = impact_result.reasoning
   ```

5. **ANOMALY loser handling:**
   ```python
   if contradiction_type == "temporal":
       loser_status = VerificationStatus.SUPERSEDED
       reasoning = "Temporal progression: claim was true at time, now superseded"
   else:  # negation, numeric, attribution
       loser_status = VerificationStatus.REFUTED
       reasoning = f"Factual contradiction ({contradiction_type}): claim conflicts"
   ```

6. **Linkage for Phase 9:**
   - Log winner_id <-> loser_id relationship
   - Include contradiction_type in log
   - This will be used for graph edges in Phase 9

**Helper method:**
```python
def _determine_loser_status(self, contradiction_type: str) -> VerificationStatus:
    """Determine loser status based on contradiction type."""
    if contradiction_type == "temporal":
        return VerificationStatus.SUPERSEDED
    return VerificationStatus.REFUTED
```
  </action>
  <verify>
`uv run python -c "
from osint_system.agents.sifters.verification.reclassifier import Reclassifier
from osint_system.agents.sifters.verification.schemas import VerificationResult, VerificationStatus
from osint_system.data_management.schemas import DubiousFlag

r = Reclassifier()
# Test loser status determination
assert r._determine_loser_status('temporal') == VerificationStatus.SUPERSEDED
assert r._determine_loser_status('negation') == VerificationStatus.REFUTED
assert r._determine_loser_status('numeric') == VerificationStatus.REFUTED
print('Reclassifier status logic correct')
"` succeeds
  </verify>
  <done>
Reclassifier preserves origin flags, updates confidence, re-assesses impact for CONFIRMED facts using lazy-initialized ImpactAssessor, handles ANOMALY resolution with context-dependent loser status
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests and exports</name>
  <files>
    tests/agents/sifters/verification/test_evidence_aggregator.py
    tests/agents/sifters/verification/test_reclassifier.py
    osint_system/agents/sifters/verification/__init__.py
  </files>
  <action>
Create comprehensive tests for both components and update exports.

**test_evidence_aggregator.py:**

Test categories (pytest, use async tests):

1. **Initialization tests:**
   - Default thresholds
   - Custom thresholds accepted
   - SourceCredibilityScorer injected or lazy-init

2. **High-authority confirmation tests:**
   - Wire service (0.9) confirms alone
   - .gov domain (0.85) confirms alone
   - .edu domain (0.85) confirms alone
   - Authority 0.84 does NOT confirm alone

3. **Multi-source confirmation tests:**
   - 2 independent news outlets (0.5 each) confirms
   - 1 news outlet alone does NOT confirm
   - 3 social media sources (0.3 each) confirms (2+)
   - Same domain doesn't count as independent

4. **Refutation tests:**
   - High-authority refutation (>=0.7) marks REFUTED
   - Low-authority refutation ignored
   - Refuting evidence requires relevance >= 0.7

5. **Confidence boost tests:**
   - Wire service adds +0.3
   - News outlet adds +0.2
   - Social media adds +0.1
   - Multiple sources cumulative
   - Total capped at 1.0

6. **Edge cases:**
   - Empty evidence list returns PENDING
   - Mixed supporting/refuting evidence
   - All irrelevant evidence returns PENDING

**test_reclassifier.py:**

Test categories (pytest, mock ClassificationStore and FactStore):

1. **Origin flag preservation tests:**
   - PHANTOM flag preserved after confirmation
   - Multiple flags preserved
   - Flags cleared from current classification

2. **Confidence update tests:**
   - Confidence boost applied correctly
   - Capped at 1.0

3. **History entry tests:**
   - Entry added with correct trigger
   - Timestamp is set

4. **ANOMALY resolution tests:**
   - Temporal contradiction -> loser SUPERSEDED
   - Negation contradiction -> loser REFUTED
   - Numeric contradiction -> loser REFUTED
   - Attribution contradiction -> loser REFUTED
   - Winner gets CONFIRMED

5. **Impact re-assessment tests:**
   - Impact tier can change after verification
   - Impact reasoning updated
   - ImpactAssessor is lazy-initialized
   - Custom ImpactAssessor can be injected

**Update __init__.py:**
Export EvidenceAggregator and Reclassifier.

Target: 20+ tests per file (40+ total).
  </action>
  <verify>
`uv run python -m pytest tests/agents/sifters/verification/test_evidence_aggregator.py tests/agents/sifters/verification/test_reclassifier.py -v` passes with 40+ tests
  </verify>
  <done>
Evidence aggregation tests verify authority thresholds and confidence boosts, reclassifier tests verify origin preservation, impact re-assessment, and ANOMALY resolution
  </done>
</task>

</tasks>

<verification>
1. `uv run python -c "from osint_system.agents.sifters.verification import EvidenceAggregator, Reclassifier"` succeeds
2. `uv run python -m pytest tests/agents/sifters/verification/test_evidence_aggregator.py -v` all tests pass
3. `uv run python -m pytest tests/agents/sifters/verification/test_reclassifier.py -v` all tests pass
4. High-authority (>=0.85) single source confirms claims
5. Confidence boosts: wire +0.3, news +0.2, social +0.1
6. Temporal contradictions mark loser SUPERSEDED, factual mark REFUTED
7. EvidenceAggregator uses SourceCredibilityScorer for consistent authority scoring
8. Reclassifier uses ImpactAssessor for impact tier re-assessment
</verification>

<success_criteria>
- EvidenceAggregator confirms with 1 high-authority (>=0.85) OR 2+ independent lower-authority sources
- EvidenceAggregator uses Phase 7 SourceCredibilityScorer for authority scoring
- Graduated confidence boosts: wire +0.3, news +0.2, social +0.1, cumulative, capped at 1.0
- Reclassifier preserves origin_dubious_flags before clearing current flags
- Reclassifier uses ImpactAssessor (lazy-init or injected) for impact re-assessment
- ANOMALY resolution: temporal -> SUPERSEDED, factual (negation/numeric/attribution) -> REFUTED
- Impact tier re-assessed with new evidence (not inherited blindly)
- 40+ tests pass covering both components
</success_criteria>

<output>
After completion, create `.planning/phases/08-verification-loop/08-03-SUMMARY.md`
</output>

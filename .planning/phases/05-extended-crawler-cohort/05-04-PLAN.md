---
phase: 05-extended-crawler-cohort
plan: 04
type: execute
---

<objective>
Enhance web scraper with hybrid httpx/Playwright approach and rate limiting.

Purpose: Create intelligent web scraping that handles both static and dynamic content efficiently.
Output: Enhanced web scraper with JavaScript rendering fallback and precise rate limiting.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-extended-crawler-cohort/05-CONTEXT.md
@.planning/phases/05-extended-crawler-cohort/05-RESEARCH.md
@.planning/phases/05-extended-crawler-cohort/05-03-SUMMARY.md
@osint_system/agents/crawlers/base_crawler.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Playwright and configure</name>
  <files>requirements.txt, setup_playwright.py</files>
  <action>Add playwright>=1.40.0 to requirements.txt. Create setup_playwright.py script that runs "playwright install chromium" to download the browser. This is needed for JavaScript-heavy sites. Also ensure httpx is already in requirements (from plan 01). The setup script should check if chromium is already installed to avoid re-downloading.</action>
  <verify>uv run python setup_playwright.py completes without errors</verify>
  <done>Playwright installed and chromium browser available</done>
</task>

<task type="auto">
  <name>Task 2: Create HybridWebCrawler class</name>
  <files>osint_system/agents/crawlers/web_crawler.py</files>
  <action>Create new HybridWebCrawler following Pattern 1 from RESEARCH.md. Implement fetch(url) that tries httpx.AsyncClient first (10x faster). Add _needs_js_rendering(response) checking for common JS frameworks indicators in HTML. Implement _playwright_fetch(url) for JS-heavy sites using async playwright. Add configurable timeouts: httpx 30s, playwright 60s. Include user-agent rotation to avoid blocking. Implement rate limiting using aiometer with configurable max_per_second (default 1). Store metrics: fetch_count, js_render_count for monitoring.</action>
  <verify>python -c "from osint_system.agents.crawlers.web_crawler import HybridWebCrawler; print('Import successful')"</verify>
  <done>HybridWebCrawler class created with httpx/Playwright fallback</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>HybridWebCrawler with JavaScript detection</what-built>
  <how-to-verify>
    1. Run: uv run python -c "from osint_system.agents.crawlers.web_crawler import HybridWebCrawler; import asyncio; crawler = HybridWebCrawler(); print(asyncio.run(crawler.fetch('https://example.com'))[:100])"
    2. Should see HTML content from example.com
    3. Check no errors in initialization or fetching
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Playwright installed with chromium
- [ ] HybridWebCrawler implements httpx-first approach
- [ ] JavaScript detection logic works
- [ ] Rate limiting with aiometer functional
</verification>

<success_criteria>
- All tasks completed
- Hybrid scraping approach implemented
- Rate limiting prevents overwhelming servers
- Human verification confirms basic functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-extended-crawler-cohort/05-04-SUMMARY.md`:

# Phase 5 Plan 4: Web Scraper Enhancement Summary

**Hybrid web scraper with intelligent JavaScript handling and rate limiting.**

## Accomplishments

- Installed and configured Playwright for JS rendering
- Created HybridWebCrawler with httpx-first approach
- Implemented JavaScript detection and fallback
- Added rate limiting with aiometer

## Files Created/Modified

- `requirements.txt` - Added playwright
- `setup_playwright.py` - Browser installation script
- `osint_system/agents/crawlers/web_crawler.py` - Created HybridWebCrawler

## Decisions Made

- httpx by default, Playwright only when JS detected
- 1 request/second default rate limit
- 30s timeout for httpx, 60s for Playwright
- User-agent rotation for anti-blocking

## Issues Encountered

[Any Playwright installation or browser issues]

## Next Step

Ready for 05-05-PLAN.md - Crawler coordination
</output>